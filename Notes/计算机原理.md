# CPU结构和工作原理

<img src=".\pic\computer_foundation.png" alt="computer_foundation" style="zoom:70%;" />

## 1 进程和线程

​	程序未运行时，存储在计算机的**硬盘**上。

​	当双击启动程序时，它被**load**到内存中，操作系统为它分配一个**进程**。

​	进程是**资源分配**的**基本单位**，它是**静态**的，只分配了资源，没有运行。 

​	操作系统找到**程序入口函数(main)**，找到的第一条指令，发送给CPU(若需要数据，也发送给CPU)。如此循环往复，直到执行完所有指令，程序结束。

​	执行main函数的地方就是程序的**主线程**，线程是**运行的基本单位**，会占用CPU的时间片，是**动态**的概念。

## 2 CPU

​	CPU的工作：① 读取程序的指令和数据；② 执行运算；③ 写回结果。

​	**程序计数器**(PC，program counter)：存储程序指令。

​	**寄存器**(Registers)：存储数据。

​	**ALU**：执行运算。

​	**CPU缓存**：提高存取数据的效率。

<img src=".\pic\computer_foundation_cpu.png" alt="computer_foundation_cpu" style="zoom:50%;" />

### 1) CPU线程切换

​	一颗CPU，在同一个时间点上，只能有一个线程运行。

​	① 当线程切换时，CPU把PC中正在执行的指令和寄存器中的数据取出，存储起来。

​	② 让其他线程的指令占用PC和寄存器。

​	③ 切换回线程时，将存储的指令和数据取出，分别放回PC和寄存器中，让线程恢复到上次暂停的地方，继续执行。

​	**线程切换是有消耗的**，因此线程数量并不是越多越好。

### 2) CPU的缓存

#### 2.1) CPU和内存速度

​	CPU访问**本地寄存器**的速度和访问**内存**的速度比约为**100:1**，即访问寄存器消耗1ns，那么访问内存中的数据大约为100ns。

​	因此，若CPU从内存中取数据，会消耗CPU时钟周期，使CPU等待。

#### 2.2) CPU缓存

​	在CPU和内存之间加入中间层：若寄存器中找不到数据，则优先在缓存中取，最后再到内存中取。

​	若**缓存层级多**，则查找命中高，但同时修改数据的代价也变高，因为要把数据同步到多级缓存中。

​	若**缓存层级少**，则修改代价低，但缓存命中也不高，可能需要频繁返回内存读取数据。

​	目前最流行的是**三级缓存**，这是权衡和妥协的结果。

#### 2.3) 三级缓存结构

# 什么是纤程？什么是协程？



# 逻辑地址，物理地址和虚拟地址

